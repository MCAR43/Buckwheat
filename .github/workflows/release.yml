name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0). Leave empty to auto-increment from latest tag.'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: read

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_id: ${{ steps.release.outputs.id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ -z "${{ github.event.inputs.version }}" ]; then
            # Get latest tag
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "Latest tag: $LATEST_TAG"
            
            # Remove 'v' prefix if present
            VERSION=${LATEST_TAG#v}
            
            # Increment patch version
            IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
            MAJOR=${VERSION_PARTS[0]:-0}
            MINOR=${VERSION_PARTS[1]:-0}
            PATCH=${VERSION_PARTS[2]:-0}
            
            PATCH=$((PATCH + 1))
            NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          else
            NEW_VERSION="${{ github.event.inputs.version }}"
            # Ensure version starts with 'v'
            if [[ ! "$NEW_VERSION" =~ ^v ]]; then
              NEW_VERSION="v${NEW_VERSION}"
            fi
          fi
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Creating release for version: $NEW_VERSION"

      - name: Create GitHub Release
        id: release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            Release ${{ steps.version.outputs.version }}
            
            ## Downloads
            - **Windows**: `Peppi_${{ steps.version.outputs.version }}_x64-setup.exe`
            - **macOS**: `Peppi_${{ steps.version.outputs.version }}_x64.dmg`
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows
    needs: create-release
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli@latest

      - name: Build frontend
        run: npm run build

      - name: Build Tauri app (Windows)
        # env:
        #   # Placeholder for Windows code signing (uncomment when ready)
        #   # CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        #   # CERTIFICATE_BASE64: ${{ secrets.WINDOWS_CERTIFICATE_BASE64 }}
        run: |
          # Uncomment when code signing is configured:
          # echo "$CERTIFICATE_BASE64" | base64 -d > certificate.pfx
          npx tauri build --target x86_64-pc-windows-msvc

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: |
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
          retention-days: 30

  build-macos:
    name: Build macOS
    needs: create-release
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin
          # Uncomment when code signing is configured:
          # targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli@latest

      - name: Build frontend
        run: npm run build

      - name: Build Tauri app (macOS)
        # env:
        #   # Placeholder for macOS code signing (uncomment when ready)
        #   # APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        #   # APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        #   # APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        #   # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Uncomment when code signing is configured:
          # security create-keychain -p "$APPLE_CERTIFICATE_PASSWORD" build.keychain
          # security default-keychain -s build.keychain
          # security unlock-keychain -p "$APPLE_CERTIFICATE_PASSWORD" build.keychain
          # security import <(echo "$APPLE_CERTIFICATE" | base64 -d) -k build.keychain -T /usr/bin/codesign -T /usr/bin/security
          # security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$APPLE_CERTIFICATE_PASSWORD" build.keychain
          npx tauri build --target x86_64-apple-darwin

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
          retention-days: 30

  upload-release:
    name: Upload to Release
    needs: [create-release, build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: ./artifacts/windows

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: ./artifacts/macos

      - name: Upload artifacts to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/windows/**/*
            ./artifacts/macos/**/*
          tag_name: ${{ needs.create-release.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

